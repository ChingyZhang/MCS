@{
    ViewBag.Title = "GetField";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>GetField</h2>

<div id="p" class="easyui-panel" title="数据表字段详细信息" style="width: 600px; height: 300px; padding: 10px;">

    <form id="fmField" method="post" novalidate>
        <input type="hidden" name="ID" />
        <input type="hidden" name="TableID" />
        <div class="fitem">
            <label>字段名称:</label>
            <input id="txtFieldName" name="FieldName" class="easyui-textbox" required="true">
        </div>
        <div class="fitem">
            <label>显示名称:</label>
            <input id="txtFieldDisplayName" name="FieldDisplayName" class="easyui-textbox" required="true">
        </div>
        <div class="fitem">
            <label>数据类型:</label>
            <input id="cmbExtFlag" name="ExtFlag" class="easyui-combobox" data-options="editable:false,required:true,panelHeight:'auto'" style="width: 155px" />
        </div>
        <div class="fitem">
            <label>长度:</label>
            <input id="txtDataLength" name="DataLength" class="easyui-textbox">
            <label>精度:</label>
            <input id="txtPrecision" name="Precision" class="easyui-textbox">
        </div>
        <div class="fitem">
            <label>默认值:</label>
            <input id="txtDefaultValue" name="DefaultValue" class="easyui-textbox">
        </div>
        <div class="fitem">
            <label>最后更新时间:</label>
            <label name="UpdateTime"></label>
        </div>
        <div class="fitem">
            <label>描述:</label>
            <input id="txtDescription" name="Description" class="easyui-textbox">
        </div>
        <div class="fitem">
            <label>关联类型:</label>
            <input id="cmbRelationType" name="RelationType" class="easyui-combobox" data-options="editable:false,required:true,panelHeight:'auto'" style="width: 155px" />
        </div>

        <div id="divRelation">
        </div>

        @* <div class="fitem">
            <label>关联字典:</label><input id="cmbRelationTableName" name="RelationTableName" class="easyui-combobox" data-options="editable:false,required:true,panelHeight:150,valueField:'Name',textField:'DisplayName',url:'/UD/GetTableList'" style="width: 155px" />
        </div>
        <div class="fitem">
            <label>关联表值字段:</label><input id="cmbRelationFieldValue" name="RelationTableName" class="easyui-combobox" data-options="editable:false,required:true,panelHeight:150,valueField:'FieldName',textField:'FieldDisplayName',url:'/UD/GetTableList'" style="width: 155px" />
        </div>
        <div class="fitem">
            <label>关联表文本字段:</label><input id="cmbRelationFieldText" name="RelationTableName" class="easyui-combobox" data-options="editable:false,required:true,panelHeight:150,valueField:'FieldName',textField:'FieldDisplayName',url:'/UD/GetTableList'" style="width: 155px" />
        </div>
</div>*@
        @*<div class="fitem">
            <label>关联字典:</label>
            <input id=’cmbRelationTableName’ name=’RelationTableName’ class=’easyui-combobox’ data-options=’editable:false,required:true,panelHeight:'auto'’ style=’width: 155px’ />
        </div>*@
    </form>

</div>

<script type="text/javascript">
    $(function () {
        FormLoad();
    });
    function FormLoad() {
        $("#txtFieldName").textbox();
        $("#txtFieldDisplayName").textbox();
        $("#cmbExtFlag").combobox({
            url: '/Dic/GetDicColByTableCode/UD_DataType',
            valueField: 'Code',
            textField: 'Name'
        });
        $("#txtDataLength").textbox();
        $("#txtDefaultValue").textbox();
        $("#txtDescription").textbox();
        $("#cmbRelationType").combobox({
            url: '/Dic/GetDicColByTableCode/UD_RelationType',
            valueField: 'Code',
            textField: 'Name',
            value: '3',
            onChange: function (newValue, oldValue) {
                GetRelationHtm(newValue);
            }
        });

        var resp = "";
        $.ajax({
            url: '/UD/GetFieldList/',
            type: 'post',
            data: { TableID: '@ViewBag.TableID', FieldID: "@ViewBag.ID" },
            async:false,
            success: function (data) { resp = data[0];}
        })
        console.log(resp);
        $("#fmField").form('load', resp);
    }

    function GetRelationHtm(RelationType) {
        var htm = "<div class='fitem'><label>关联字典:</label><input id=cmbRelationTableName name=RelationTableName class=easyui-combobox data-options=editable:false,required:true,panelHeight:'150' style=width:155px /></div>"

        if (RelationType == 1) {
            $("#divRelation").html(htm);
            $("#cmbRelationTableName").combobox({
                url: '/Dic/GetDicList',
                valueField: 'Code',
                textField: 'Name'
            });
        } else if (RelationType == 2) {
            htm += '<div class="fitem"><label>关联表值字段:</label><input id="cmbRelationFieldValue" name="RelationFieldValue" class="easyui-combobox"  data-options="editable:false,required:true,panelHeight:150,valueField:\'FieldName\',textField:\'FieldDisplayName\',url:\'/UD/GetFieldList\'" style="width: 155px" /></div>';
            htm += '<div class="fitem"><label>关联表文本字段:</label><input id="cmbRelationFieldText" name="RelationFieldText" class="easyui-combobox"  data-options="editable:false,required:true,panelHeight:150,valueField:\'FieldName\',textField:\'FieldDisplayName\',url:\'/UD/GetFieldList\'" style="width: 155px" /></div>';
            $("#divRelation").html(htm);
            console.log(htm);
            $("#cmbRelationTableName").combobox({
                url: '/UD/GetTableList',
                valueField: 'Name',
                textField: 'DisplayName',
                onChange: function (newValue, oldValue) {
                    var result = '';
                    $.ajax({
                        url: '/UD/GetFieldList' + newValue,
                        type: 'POST',
                        async: 'false',
                        dataType: "json",
                        success: function (data) { result = data; }
                    })

                    $("#cmbRelationFieldValue").combobox({
                        //url: '/UD/GetFieldList' + newValue,
                        data: result,
                        valueField: 'FieldName',
                        textField: 'FieldDisplayName'
                    });
                    $("#cmbRelationFieldText").combobox({
                        //url: '/UD/GetFieldList' + newValue,
                        data: result,
                        valueField: 'FieldName',
                        textField: 'FieldDisplayName'
                    });
                }
            });
        }
    }
</script>
